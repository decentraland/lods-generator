name: CI/CD on main branch

on:
  push:
    branches:
      - main

jobs:
  quay-build-push:
    runs-on: windows-2019
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v2
        with:
          lfs: true
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.0.0
        with:
          vulkan_version: 1.3.268.0
          optional_components: com.lunarg.vulkan.vma
          install_runtime: true
          cache: true
          destination: ${{ github.workspace }}/vulkan-sdt
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}
      - name: Build and push
        id: docker_build
        run: |
          docker build --no-cache --build-arg COMMIT_HASH=${{ github.sha }} --build-arg VULKAN_DLL_PATH=./vulkan-sdt/1.3.268.0/runtime/x64/vulkan-1.dll -t quay.io/decentraland/lods-generator:next -t quay.io/decentraland/lods-generator:${{ github.sha }} .
          docker push quay.io/decentraland/lods-generator:next
          docker push quay.io/decentraland/lods-generator:${{ github.sha }}