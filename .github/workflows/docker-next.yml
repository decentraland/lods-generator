name: CI/CD on main branch

on:
  push:
    branches:
      - feat/cd
  # workflow_call:
  #   inputs:
  #     service-name:
  #       required: true
  #       type: string
  #     image-name:
  #       required: false
  #       type: string
  #     deployment-environment:
  #       required: false
  #       type: string
  #     docker-tag:
  #       required: false
  #       type: string
  #       default: next
  #     build-args:
  #       required: false
  #       type: string
  #     layers:
  #       required: false
  #       type: boolean
  #       default: true
  #     dockerfile-url:
  #       required: false
  #       type: string
  #   secrets:
  #     QUAY_USERNAME:
  #       required: true
  #     QUAY_TOKEN:
  #       required: true
    # outputs:
    #   registry-path:
    #     description: "Registry path"
    #     value: ${{ jobs.quay-build-push.registry-path }}
    #   registry-paths:
    #     description: "Registry paths (JSON)"
    #     value: ${{ jobs.quay-build-push.registry-paths }}

jobs:
  quay-build-push:
    runs-on: windows-2019
    outputs:
      registry-path: ${{ steps.push-to-quay.outputs.registry-path }}
      registry-paths: ${{ steps.push-to-quay.outputs.registry-paths }}
    steps:
      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.0.0
        with:
          vulkan_version: 1.3.268.0
          optional_components: com.lunarg.vulkan.vma
          install_runtime: true
          cache: true
          destination: ${{ github.workspace }}/vulkan-sdt
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v3
        with:
          context: .
          tags: quay.io/decentraland/lods-generator:next,quay.io/decentraland/lods-generator:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            COMMIT_HASH=${{ github.sha }}
            VULKAN_DLL_PATH=./vulkan-sdt/1.3.268.0/runtime/x64/vulkan-1.dll